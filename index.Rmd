---
title: "NEON Ecological Forecasting Challenge Dashboard"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: "cosmo"
runtime: shiny
---
```{r setup, include = FALSE}
library(flexdashboard)
library(shiny)
library(gganimate)
library(plotly)
library(tidyverse)
library(ncdf4)
library(scales)
library(readr)

```

Plot Forecast
=======================================================================

Pick Forecast Category {.sidebar}
-----------------------------------------------------------------------

```{r}
#THIS FILE PATH NEEDS TO BE CHANGED - currently set to my local files
base.dir = '/efi_neon_challenge/forecasts/'
target.dir = "/efi_neon_challenge/targets/"

dirs = reactive({ list.files(path = "/efi_neon_challenge/forecasts", recursive = FALSE ) })


renderUI({
selectInput("forecast", "Forecast theme:", 
            choices = basename(dirs()), selected = dirs()[4])
      })


#based on choice above, reads file in dir and creates new inputs to select from 

files = reactive({ list.files(path = paste0(base.dir, input$forecast))})


#file selection 
renderUI({
    selectInput('file', 'Select Forecast File:',
                choices = files(), selected = files()[2])
   })

#creates files path from above selection
file.path = reactive({paste0(base.dir, input$forecast, "/", input$file)})

#reads selected data - used readr's read_csv so we can read zip files
data <- reactive({as.data.frame(read_csv(file.path()))})

#gets names of data for next selection
vars <- reactive({names(data())})

target_variables <- c("oxygen", "temperature", "richness", "abundance", "nee", "le", "vswc", "gcc_90")

grouping_variables <- c("siteID")

x_axis_variables <- c("time")

y.inputs = reactive(vars()[which(vars() %in% target_variables)])
g.inputs = reactive(vars()[which(vars() %in% grouping_variables)])
x.inputs = reactive(vars()[which(vars() %in% x_axis_variables)])


#allow user selection of y and grouping variable
renderUI({
  
  selectInput('x.var', "Select Variable for X-Axis:", 
              choices = x.inputs(), selected = x.inputs()[1])
  
})


renderUI({
  
  selectInput('y.var', "Select Variable for Y-Axis:", 
              choices = y.inputs(), selected = y.inputs()[1])
  
})

renderUI({
  
  selectInput('group', "Select Grouping Variable:", 
              choices = c(g.inputs(), "NA"))
  
})

target.files.1 <-  reactive({list.files(path = paste0(target.dir, input$forecast))})
target.files <- reactive(target.files.1()[-which(target.files.1() == 'prov.json')])

renderUI({
  
  selectInput('target', "Select Target File:", 
              choices = target.files(), selected = target.files()[2])
  
})
  
#this is to set up data cleaning for the graphing section
index.x <- reactive(which(names(data()) == input$x.var))
index.y <- reactive(which(names(data()) == input$y.var))
index.g <- reactive(which(names(data()) == input$group))
  
 # reactive({if(is.na(input$group)){"NA"} else(which(names(data()) == input$group))})
  
var.x <- reactive(data()[,index.x()])
var.y <- reactive(data()[,index.y()])
var.g <- reactive(data()[,index.g()]) 
  #reactive({
#  if(input$group == "NA"){rep(1, times = length(var.x()))}else(data()[,index.g()])})

#allows users to check out the head of the data 
#renderPrint(head(data()))

```


Forecast Plot 
-------------------------------------

```{r}
#clean data and aggregate for graphing 
 data.sum <- reactive({

   data() %>%
        mutate(var.x = var.x(), var.y = var.y(), var.g = as.factor(var.g())) %>% 
         group_by(var.g, var.x) %>%
        summarize(med = quantile(var.y, 0.5, na.rm = TRUE),
                   upper = quantile(var.y, 0.975, na.rm = TRUE),
                  lower = quantile(var.y, 0.025, na.rm = TRUE))
 
 
 })
```


### Forecast and Observed Plot 

```{r}

#change to targets path 
#this is assuming the files are set up the same which holds true right now but might not? 

target.path = reactive(paste0(target.dir, input$forecast, "/", input$target))

targets<- reactive({as.data.frame(read_csv(target.path()))})
 
  
#this is to set up data cleaning for the graphing section 
  target.x <- reactive(which(names(targets()) == input$x.var))
  target.y <- reactive(which(names(targets()) == input$y.var))
  target.g <- reactive(which(names(targets()) == input$group))
  #target.g <- reactive({if(is.na(input$group)){"NA"} else(which(names(targets()) == input$group))})
  #target.sd <- reactive(which(names(targets()) == paste0(input$y.var, "_sd")))
  #sd is something we could add in if all had sd on data 


  target.var.x <- reactive(targets()[,target.x()])
  target.var.y <- reactive(targets()[,target.y()])
  target.var.g <- reactive(targets()[,target.g()])
  #if(input$group == "NA"){rep(1, times = length(target.var.x()))}else(targets()[,index.g()])})
  #target.sd.y <- reactive(targets()[,target.sd()])


targets.sum <- reactive({
  
    targets() %>%
          mutate(var.x = target.var.x(), var.y =  target.var.y(), var.g = as.factor(target.var.g()), time = as.Date(time))  #sd = 
   })


  
 
 combo <- reactive({
      
      left_join(data.sum(),targets.sum(), by = c("var.x", "var.g"), suffix = c('_data', '_target'))
      
    })
 

 
 target.plot <- reactive({
   
   print(head(combo()))
   
   if(!all(is.na(combo()$var.y))){
       ggplot(data = combo(), aes(y = med, x = var.x, group = var.g)) + 
       geom_line(data = combo(), aes(x = var.x, y = med, color = "Forecast")) + 
       geom_ribbon(aes(x = var.x, ymin = lower, ymax = upper, fill = "Forecast"), alpha = 0.4) +
       geom_point(data = combo(), aes(x =var.x, y = var.y, color = "Target"), size = 1.5) + 
       labs(x = input$x.var, y = input$y.var) +
       facet_wrap(~var.g)}else{
      
      ggplot(data = data.sum(), aes(y = med, x = var.x, group = var.g)) + 
          geom_line(data = data.sum(), aes(x =var.x, y = med, color = var.g)) + 
          geom_ribbon(aes(x = var.x, ymin = lower, ymax = upper, fill = var.g), alpha = 0.4) +
          labs(x = input$x.var, y = input$y.var) +
          facet_wrap(~var.g)
         }
       
     })


 renderPlot({
   
   target.plot()
   
 })




```



### Historical Time-series of Target

```{r}

#plot full target plot 
 renderPlot({
      ggplot(data = targets.sum()) + 
        geom_point(aes(x = var.x, y = var.y, color = "Observed Data")) + 
        facet_wrap(~var.g) + 
        #scale_x_date(date_breaks = "6 month", date_labels =  "%b %Y") +
        labs(x = input$x.var, y = input$y.var)
 
     })

```


